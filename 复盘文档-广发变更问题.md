# 广发变更问题复盘文档

## 一、问题概述

**影响范围：** 维护期功能  
**问题等级：** 高（功能不可用）  
**处理状态：** 已临时解决，待正式修复

---

## 二、问题描述

### 2.1 现象
变更部署后，系统维护期功能无法正常加载，页面接口调用超时。其他功能模块可正常使用。

### 2.2 影响
- 维护期功能完全不可用
- 业务操作受阻

---

## 三、排查过程

### 3.1 问题定位
1. **初步排查：** 通过平台页面接口监控，发现维护期接口调用异常
2. **日志分析：** 查看后台日志报错信息，发现以下关键信息：
   - 维护期接口查询超时
   - 接口调用超时被取消
   - 后台日志存在SQL报错信息
3. **慢查询定位：** 通过广发内部的慢查询SQL监控，找到具体的慢查询SQL语句
4. **SQL条件分析：** 通过依次调整SQL中的where查询条件进行性能测试：
   - **测试1：** 仅包含 `IN (权限)` 条件 → 查询速度快 ✅
   - **测试2：** 仅包含 `tupdate_user` 和 `tcreate_user` 作为条件 → 查询速度快 ✅
   - **测试3：** 同时包含所有条件（IN权限 + tupdate_user + tcreate_user） → 查询速度慢 ❌
5. **问题确认：** 通过上述测试方式，确认查询慢产生的具体原因是多个条件组合查询时，SQL执行计划选择不当导致性能下降

### 3.2 环境对比
- **内网测试环境：** 同样的问题在内网测试环境没有出现，查询响应正常
- **模拟测试环境：** 模拟数据量与现场一致，查询响应时间在2秒以内
- **现场生产环境：** 相同数据量查询耗时30多秒，导致接口超时

---

## 四、原因分析

### 4.1 原因猜测

**具体表现：**
- 单个查询条件（如仅IN权限条件，或仅tupdate_user/tcreate_user条件）执行速度快
- 多个条件组合查询时，MySQL执行计划选择不当，导致查询性能急剧下降（从2秒内增加到30多秒）
- 在广发生产环境的MySQL配置下，OR查询方式无法有效利用索引，导致全表扫描或低效的索引使用

**异常现象分析：**
- **数据量分析：** 主表数据总共只有1000条左右，数据量并不大
- **性能异常：** 即使发生全表扫描，1000条数据的全表扫描也不应该需要30多秒，这个性能表现明显异常
- **可能因素：** 怀疑与MySQL自身存在一定关系

### 4.2 为什么测试环境未发现
- **内网测试环境：** 同样的问题在内网测试环境没有出现，查询性能表现正常
- **模拟测试环境：** 数据量模拟与现场一致，但查询性能表现正常（2秒内）
- **环境差异：** 未充分考虑到生产环境MySQL配置差异对查询性能的影响
- **测试不足：** 缺少对复杂SQL查询的性能压测，特别是在不同MySQL配置下的性能测试

---

## 五、解决方案

### 5.1 临时解决方案
**实施方式：** 指导现场同事将jar包拷贝到本地，修改SQL查询方式

**技术方案：** 
- 将原有的OR查询方式改为UNION ALL方式
- 通过优化查询结构提升查询性能

**效果：** 
- ✅ 服务可正常启动
- ✅ 维护期功能无报错

### 5.2 正式解决方案（待实施）
- 研发计划周一在家解决问题后重新出包
- 修改查询方式为适合前场版本的unoin的方式
- 出包时间待安排

---

## 六、下一步计划

### 6.1 短期计划
1. **研发修复：** 周一完成SQL查询优化，重新打包
2. **测试验证：** 昊铸验证维护期功能使用情况

### 6.2 长期改进
1. **环境对比分析：** 
   - 将前场MySQL配置，版本等信息拿回内部
   - 构建相同环境，排查性能差异的根本原因

---

## 七、经验总结与改进建议

### 7.1 经验教训
1. **环境差异影响：** 测试环境与生产环境的MySQL配置差异可能导致性能问题，需要充分重视
2. **SQL优化重要性：** OR查询在大数据量场景下性能较差，应优先考虑使用UNION ALL等更高效的查询方式
3. **性能测试不足：** 需要在更接近生产环境的情况下进行性能测试
4. **环境一致性检查：** 在测试环境尽可能模拟生产环境配置

---

